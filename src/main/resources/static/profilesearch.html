<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Profile Page</title>
	<link rel="icon" href="assets/img/AIchatlogo.png">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
	<link rel="stylesheet" href="/assets/css/profile.css">
	<link href="https://fonts.googleapis.com/css?family=DM Sans" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body >
	<!-- nav bar -->
	<div id="navbar-placeholder"></div>
	<div id="editprofilepopup-placeholder"></div>
	

	<!-- page body content -->
	<div  class="px-5 container-fluid">

		<!-- Top of Profile -->
		<div class="d-flex row mt-3">
            <!-- Profile icon -->
            <i class="fa-solid fa-circle-user responsive-icon w-auto pr-1 pt-1" style="color: #535355;"></i>
            <div class="col">
                <!-- Profile user data -->
                <div class="row">
                    <!-- Name & username -->
                    <div class="col">
                        <h1 class="h-auto w-auto pb-0 mb-0" id="profileName"></h1>
                        <h4 class="w-auto pb-username" id="profileUsername"></h4>
                    </div>
                    <!-- Edit and Log out buttons -->
                    <div class="row w-auto h-auto pt-0">
                        
                        <div class="w-auto h-auto">
                            <button class="w-auto h-auto text-white border-0 rounded fs-4 follow-button"
                                 ></button>
                        </div>
                    </div>
                </div>
                <!-- Followers, Following, Chatters made -->
                <div class="row">
                    <h4 class="w-auto p-1" id="followersPlaceholder"></h4>
                    <h4 class="w-auto p-1">Followers</h4>
                    <h4 class="w-auto p-1" id="followingPlaceholder"></h4>
                    <h4 class="w-auto p-1">Following</h4>
                    <!-- <h4 class="w-auto p-1" id="chattersPlaceholder"></h4>
                    <h4 class="w-auto p-1">Chatters</h4> -->
                </div>
            </div>
        </div>

		<!-- Recent chatter circles -->
		
		<div class="character-circ-container"></div>
		<!-- Original chatters scroll -->
		<!-- <h1 class="mt-3">Original Chatters</h1>
		<div class="row" style="overflow-x: auto; white-space: nowrap;">
			<div class="col">
				<div class="d-flex" style="width: 100%; overflow-x: auto; white-space: nowrap;">
					<div class="B-character-card-container d-flex flex-row justify-content-start"></div>
				</div>
			</div>
		</div>  -->
	</div>
	
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
	<script src="assets/js/script.js"></script>
	<script>
		$(document).ready(function () {
			// Load navbar
			$('#navbar-placeholder').load('navbar.html', function () {
				$('.discover-icon').addClass('active');
			});
			loadProfileSearch();
		});
		function follow() {
			var currentUsername = JSON.parse(Cookies.get('profile')).username;
			var otherUsername = (JSON.parse(localStorage.getItem('selectedProfile'))).username;
			const followData = {
					currentUsername: currentUsername,
					otherUsername: otherUsername,
				};
			
				$.ajax({
					type: 'POST',
					url: '/follow',
					contentType: 'application/json',
					data: JSON.stringify(followData),
					success: function(response) {
						loadProfileSearch();
					},
				});
		}
		function unfollow() {
			var currentUsername =  JSON.parse(Cookies.get('profile')).username;
			var otherUsername = (JSON.parse(localStorage.getItem('selectedProfile'))).username;
			const unfollowData = {
					currentUsername: currentUsername,
					otherUsername: otherUsername,
				};
			
				$.ajax({
					type: 'POST',
					url: '/unfollow',
					contentType: 'application/json',
					data: JSON.stringify(unfollowData),
					success: function(response) {
						loadProfileSearch();
					}
				});
		}
		function loadProfileSearch() {
			
			const currentProfile = JSON.parse(Cookies.get('profile'));
			let currentProfileUsername = null;
			if(JSON.parse(Cookies.get('profile'))) {
				currentProfileUsername = JSON.parse(Cookies.get('profile')).username;
				$.ajax({
					type: 'GET',
					url: `/findByUsername`,
					data: { username: currentProfileUsername },
					success: function(response) {
						Cookies.set('profile', JSON.stringify(response), { path: '/' }); 
					}
				})
			}
			$.ajax({
				type: 'GET',
				url: `/findByUsername`,
				data: { username: JSON.parse(localStorage.getItem('selectedProfile')).username },
				success: function(searchProfile) {
					
					
					if (searchProfile) {
						$('#profileName').text(searchProfile.name);
						$('#profileUsername').text('@'+searchProfile.username);
						$('#followersPlaceholder').text((searchProfile.followers && searchProfile.followers.length) || 0); 
						$('#followingPlaceholder').text((searchProfile.following && searchProfile.following.length) || 0); 
					}
					const $followButton = $('.follow-button');

					if(currentProfileUsername) {
						if(searchProfile.followers && searchProfile.followers.includes(currentProfile.id)) {
							$followButton.text('Unfollow');
		                    $followButton.css('background', '#535355');
		                    $followButton.off('click').on('click', unfollow);
						} else {
							$followButton.text('Follow');
		                    $followButton.css('background', '#FF206E');
		                    $followButton.off('click').on('click', follow);
						}
					} else {
						$followButton.off('click'); 
						$followButton.text('Follow');
	                    $followButton.css('background', '#535355');
					}
					
					const container = $('.character-circ-container');

					// Add the header to the container
					if(searchProfile.myChatters.length) {
						container.empty();
						container.append('<h1 class="mt-3 display-4">Recents</h1>');
						
						// Fetch chattercard template
						$.get('chattercircle.html', function(template) {
							searchProfile.myChatters.forEach(character => {
								const populatedCircle = populateCircle(template, character);
								container.append(populatedCircle);
							});
						})
					}
					
				}
			})

			
			
		}
	</script>
</body>

</html>